@startuml

actor "Customer" as A
participant "Merchant platform" as B
participant "Payment Gateway" as C
database DB  #gold
participant "IPGeo system" as D #lightblue
participant "Anti-Fraud system" as E
participant "VTS" as F
participant "MDES" as G
participant "Card-Issuing Bank" as H

==Purchase registration==
"A" ->> "B": 1 Places an order
Activate A
Activate B
"B" ->> "C": 2 Registers an order
Activate C
"C" ->> DB: 3 saves Order data
"C" ->> "D": 4 Request to determine customer's country
Activate D
"C" <-- "D": 5 Response with customers country
Deactivate D

"C" ->> "C": 6 Choses approprient country oriented template for payment form
"B" <-- "C": 7 Response with payment form template
"A" <-- "B": 8 Redirects customers to the payment form
Deactivate C
Deactivate B


==Purchase payment==
"A" ->> "A": 1 Fills out payment form
Activate A
"A" ->> "C": 2 Sends the payment form with a credit card data
Activate C


Deactivate A
"C" ->> "C": 3 Receives the customer's card data
"C" ->> "C": 4 Invokes card data validation

group Card network determinations [choosing visa or mc]
"C" ->> "C": 4 Determines card network brand

alt VISA
"C" ->> "F":  5 Sends request with PAN to get DPAN
Activate F
"C" <-- "F":  6 Receives response with DPAN
Deactivate F
end
alt Master Card
"C" ->> "G":  5 Sends request with PAN to get DPAN
Activate G
"C" <-- "G":  6 Receives response with DPAN
Deactivate G
end
end

"C" ->> DB: 7 saves Order data
Deactivate C

==Anti-Fraud check==

"C" ->> "E": 1 Sends the order for anti-fraud check
Activate C
Activate E
"E" ->> "E": 2 Invokes anti fraud screeneng
"C" <-- "E": 3 Sends screeneng results
Deactivate E
"C" ->> DB: 4 saves results of the check
Deactivate C

==Transaction authorization==
"C" ->> "H": 1 Sends request according to the bank's BIN
Activate C
Activate H
"H" ->> "H": 2 Invokes checks in order to authorize the transaction
"C" <-- "H": 3 Receives results
Deactivate H
"C" ->> DB: 4 saves results of the check
Deactivate C
"A" <-- "C": 3 Retreives results of the payment
Activate C
Deactivate A

alt Purchase cancellation
"A" ->> "A":  Requests payment cancellation
"A" ->> "B": Registers cancelation
"B" ->> "C": 2 Registers an order

end


@enduml

